{% extends "base.html" %}

{% block title %}{{ module.title }} - Quiz{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ module.title }} - Quiz</h1>
    <div class="quiz-container">
        <form id="quiz-form">
            <div class="quiz-questions">
                <!-- Questions will be loaded dynamically -->
                <p id="loading-indicator">Loading quiz questions...</p>
            </div>
            <button type="submit" class="btn btn-primary">Submit Quiz</button>
        </form>
    </div>
    <div class="module-navigation">
        <a href="{{ url_for('modules.video', module_id=module.id) }}" class="btn btn-secondary">Back to Video</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const quizForm = document.getElementById('quiz-form');
    const questionsContainer = document.querySelector('.quiz-questions');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    console.log("Loading quiz for Module ID: {{ module.id }}");
    
    // Load quiz questions from the server
    fetch(`/static/quizzes/{{ module.id }}_quiz.json`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Quiz file not found');
            }
            return response.json();
        })
        .then(data => {
            // Remove loading indicator
            loadingIndicator.remove();
            
            // Display questions
            data.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <p class="question-text">${index + 1}. ${question.text}</p>
                    <div class="options">
                        ${question.options.map((option, optIndex) => `
                            <label>
                                <input type="radio" name="q${index}" value="${optIndex}">
                                ${option}
                            </label>
                        `).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });
        })
        .catch(error => {
            console.error('Error loading quiz:', error);
            questionsContainer.innerHTML = '<p class="error">Error loading quiz questions. Please try again later.</p>';
        });

    quizForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const answers = [];
        const questions = document.querySelectorAll('.question');
        questions.forEach((question, index) => {
            const selected = question.querySelector(`input[name="q${index}"]:checked`);
            if (selected) {
                answers.push(parseInt(selected.value));
            } else {
                answers.push(null); // No answer selected
            }
        });

        // Check if all questions are answered
        if (answers.includes(null)) {
            alert('Please answer all questions before submitting.');
            return;
        }

        // Submit answers to server
        fetch('{{ url_for("modules.submit_quiz") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                module_id: {{ module.id }},
                answers: answers
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`Quiz completed! Your score: ${data.score}%`);
                window.location.href = "{{ url_for('modules.index') }}";
            } else {
                alert('Error submitting quiz. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error submitting quiz:', error);
            alert('Error submitting quiz. Please try again.');
        });
    });
});
</script>

<style>
.quiz-container {
    margin: 20px 0;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 5px;
}
.question {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}
.question-text {
    font-weight: bold;
    margin-bottom: 10px;
}
.options label {
    display: block;
    margin: 5px 0;
    cursor: pointer;
}
.error {
    color: red;
    font-weight: bold;
}
#loading-indicator {
    font-style: italic;
    color: #666;
}
</style>
{% endblock %} 